#!/usr/bin/env python3
"""
Teste Completo com Selenium - Sistema de Sele√ß√£o e An√°lise de Editais
"""

import time
import json
import requests
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from webdriver_manager.chrome import ChromeDriverManager
import pytest

class TesteSistemaCompleto:
    def __init__(self):
        self.driver = None
        self.frontend_url = "http://localhost:3001"
        self.backend_url = "http://localhost:8002"
        self.wait_timeout = 15
        
    def setup_driver(self):
        """Configura o driver do Chrome"""
        print("üîß Configurando driver do Chrome...")
        
        chrome_options = Options()
        chrome_options.add_argument("--headless")  # Executar sem interface gr√°fica
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--window-size=1920,1080")
        
        service = Service(ChromeDriverManager().install())
        self.driver = webdriver.Chrome(service=service, options=chrome_options)
        self.driver.implicitly_wait(5)
        
        print("‚úÖ Driver configurado com sucesso!")
        
    def teardown_driver(self):
        """Fecha o driver"""
        if self.driver:
            self.driver.quit()
            print("üîí Driver fechado")
    
    def test_backend_health(self):
        """Testa se o backend est√° funcionando"""
        print("\nüß™ Testando sa√∫de do backend...")
        
        try:
            response = requests.get(f"{self.backend_url}/health", timeout=5)
            assert response.status_code == 200
            
            data = response.json()
            assert data["status"] == "healthy"
            assert data["service"] == "edital-analyzer"
            assert data["ai_available"] == True
            
            print("‚úÖ Backend est√° saud√°vel!")
            return True
            
        except Exception as e:
            print(f"‚ùå Backend n√£o est√° funcionando: {e}")
            return False
    
    def test_api_concursos(self):
        """Testa a API de concursos"""
        print("\nüß™ Testando API de concursos...")
        
        try:
            # Teste 1: Listar concursos
            response = requests.get(f"{self.backend_url}/editais/concursos", timeout=10)
            assert response.status_code == 200
            
            concursos = response.json()
            assert len(concursos) > 0
            print(f"‚úÖ API concursos OK - {len(concursos)} concursos encontrados")
            
            # Teste 2: Filtro por banca
            response = requests.get(f"{self.backend_url}/editais/concursos?banca=CESPE", timeout=10)
            assert response.status_code == 200
            
            concursos_cespe = response.json()
            print(f"‚úÖ Filtro por banca OK - {len(concursos_cespe)} concursos CESPE")
            
            # Teste 3: Conte√∫do do edital
            if concursos:
                primeiro_concurso = concursos[0]
                response = requests.get(f"{self.backend_url}/editais/concursos/{primeiro_concurso['id']}/edital", timeout=10)
                assert response.status_code == 200
                
                edital_data = response.json()
                assert len(edital_data['conteudo']) > 100
                print(f"‚úÖ Conte√∫do do edital OK - {len(edital_data['conteudo'])} caracteres")
            
            return True
            
        except Exception as e:
            print(f"‚ùå Erro na API de concursos: {e}")
            return False
    
    def test_frontend_access(self):
        """Testa se o frontend est√° acess√≠vel"""
        print("\nüß™ Testando acesso ao frontend...")
        
        try:
            self.driver.get(self.frontend_url)
            WebDriverWait(self.driver, self.wait_timeout).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            
            title = self.driver.title
            print(f"‚úÖ Frontend acess√≠vel! T√≠tulo: {title}")
            return True
            
        except TimeoutException:
            print("‚ùå Frontend n√£o est√° respondendo")
            return False
        except Exception as e:
            print(f"‚ùå Erro ao acessar frontend: {e}")
            return False
    
    def test_pagina_selecionar_concurso(self):
        """Testa a p√°gina de sele√ß√£o de concursos"""
        print("\nüß™ Testando p√°gina de sele√ß√£o de concursos...")
        
        try:
            self.driver.get(f"{self.frontend_url}/selecionar-concurso")
            
            # Aguardar carregamento
            WebDriverWait(self.driver, self.wait_timeout).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            
            # Verificar elementos da p√°gina
            page_elements = [
                "Selecionar Concurso",
                "Escolha um concurso p√∫blico",
                "Filtros",
                "Buscar"
            ]
            
            for element_text in page_elements:
                try:
                    element = self.driver.find_element(By.XPATH, f"//*[contains(text(), '{element_text}')]")
                    print(f"‚úÖ Elemento encontrado: {element_text}")
                except NoSuchElementException:
                    print(f"‚ö†Ô∏è Elemento n√£o encontrado: {element_text}")
            
            # Aguardar carregamento dos concursos
            time.sleep(3)
            
            # Verificar se h√° concursos carregados
            try:
                concursos = self.driver.find_elements(By.XPATH, "//div[contains(@class, 'space-y-6')]//div[contains(@class, 'p-6')]")
                if len(concursos) > 0:
                    print(f"‚úÖ Concursos carregados: {len(concursos)} encontrados")
                else:
                    print("‚ö†Ô∏è Nenhum concurso carregado na interface")
            except:
                print("‚ö†Ô∏è N√£o foi poss√≠vel verificar concursos carregados")
            
            print("‚úÖ P√°gina de sele√ß√£o de concursos acess√≠vel!")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao acessar p√°gina de sele√ß√£o: {e}")
            return False
    
    def test_filtros_concursos(self):
        """Testa os filtros de concursos"""
        print("\nüß™ Testando filtros de concursos...")
        
        try:
            self.driver.get(f"{self.frontend_url}/selecionar-concurso")
            
            # Aguardar carregamento
            WebDriverWait(self.driver, self.wait_timeout).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            
            time.sleep(3)  # Aguardar carregamento dos concursos
            
            # Teste filtro por banca
            try:
                banca_input = WebDriverWait(self.driver, 5).until(
                    EC.presence_of_element_located((By.ID, "banca"))
                )
                banca_input.clear()
                banca_input.send_keys("CESPE")
                time.sleep(2)
                print("‚úÖ Filtro por banca aplicado")
            except TimeoutException:
                print("‚ö†Ô∏è Campo de filtro por banca n√£o encontrado")
            
            # Teste filtro por √≥rg√£o
            try:
                orgao_input = self.driver.find_element(By.ID, "orgao")
                orgao_input.clear()
                orgao_input.send_keys("TRT")
                time.sleep(2)
                print("‚úÖ Filtro por √≥rg√£o aplicado")
            except NoSuchElementException:
                print("‚ö†Ô∏è Campo de filtro por √≥rg√£o n√£o encontrado")
            
            # Teste filtro por n√≠vel
            try:
                nivel_select = self.driver.find_element(By.ID, "nivel")
                from selenium.webdriver.support.ui import Select
                select = Select(nivel_select)
                select.select_by_value("superior")
                time.sleep(2)
                print("‚úÖ Filtro por n√≠vel aplicado")
            except NoSuchElementException:
                print("‚ö†Ô∏è Campo de filtro por n√≠vel n√£o encontrado")
            
            print("‚úÖ Filtros de concursos testados!")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao testar filtros: {e}")
            return False
    
    def test_selecao_concurso(self):
        """Testa a sele√ß√£o de um concurso"""
        print("\nüß™ Testando sele√ß√£o de concurso...")
        
        try:
            self.driver.get(f"{self.frontend_url}/selecionar-concurso")
            
            # Aguardar carregamento
            WebDriverWait(self.driver, self.wait_timeout).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            
            time.sleep(5)  # Aguardar carregamento dos concursos
            
            # Procurar por bot√£o "Analisar Edital"
            try:
                analisar_buttons = self.driver.find_elements(By.XPATH, "//button[contains(text(), 'Analisar Edital')]")
                if len(analisar_buttons) > 0:
                    print(f"‚úÖ Bot√µes 'Analisar Edital' encontrados: {len(analisar_buttons)}")
                    
                    # Clicar no primeiro bot√£o
                    analisar_buttons[0].click()
                    print("‚úÖ Bot√£o 'Analisar Edital' clicado!")
                    
                    # Aguardar redirecionamento
                    time.sleep(3)
                    
                    # Verificar se foi redirecionado para p√°gina de an√°lise
                    current_url = self.driver.current_url
                    if "analise-editais" in current_url:
                        print("‚úÖ Redirecionamento para an√°lise bem-sucedido!")
                        
                        # Verificar se h√° indicador de concurso selecionado
                        try:
                            concurso_selecionado = self.driver.find_element(By.XPATH, "//*[contains(text(), 'Concurso Selecionado')]")
                            print("‚úÖ Indicador de concurso selecionado encontrado!")
                        except NoSuchElementException:
                            print("‚ö†Ô∏è Indicador de concurso selecionado n√£o encontrado")
                        
                        return True
                    else:
                        print(f"‚ùå Redirecionamento falhou. URL atual: {current_url}")
                        return False
                else:
                    print("‚ùå Nenhum bot√£o 'Analisar Edital' encontrado")
                    return False
                    
            except Exception as e:
                print(f"‚ùå Erro ao clicar no bot√£o: {e}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro ao testar sele√ß√£o de concurso: {e}")
            return False
    
    def test_analise_automatica(self):
        """Testa a an√°lise autom√°tica ap√≥s sele√ß√£o"""
        print("\nüß™ Testando an√°lise autom√°tica...")
        
        try:
            # Primeiro, selecionar um concurso
            self.driver.get(f"{self.frontend_url}/selecionar-concurso")
            
            WebDriverWait(self.driver, self.wait_timeout).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            
            time.sleep(5)  # Aguardar carregamento
            
            # Clicar em "Analisar Edital"
            try:
                analisar_buttons = self.driver.find_elements(By.XPATH, "//button[contains(text(), 'Analisar Edital')]")
                if len(analisar_buttons) > 0:
                    analisar_buttons[0].click()
                    time.sleep(3)
                    
                    # Verificar se chegou na p√°gina de an√°lise
                    if "analise-editais" in self.driver.current_url:
                        print("‚úÖ Chegou na p√°gina de an√°lise")
                        
                        # Verificar se o formul√°rio foi preenchido automaticamente
                        try:
                            textarea = self.driver.find_element(By.ID, "conteudoEdital")
                            conteudo = textarea.get_attribute("value")
                            
                            if conteudo and len(conteudo) > 100:
                                print(f"‚úÖ Formul√°rio preenchido automaticamente - {len(conteudo)} caracteres")
                                
                                # Clicar em "Analisar Edital"
                                try:
                                    analisar_btn = self.driver.find_element(By.XPATH, "//button[contains(text(), 'Analisar Edital')]")
                                    analisar_btn.click()
                                    print("‚úÖ Bot√£o 'Analisar Edital' clicado!")
                                    
                                    # Aguardar an√°lise
                                    print("‚è≥ Aguardando an√°lise...")
                                    time.sleep(10)
                                    
                                    # Verificar se apareceram resultados
                                    try:
                                        resultados = WebDriverWait(self.driver, 10).until(
                                            EC.presence_of_element_located((By.XPATH, "//*[contains(text(), 'Resultados da An√°lise')]"))
                                        )
                                        print("‚úÖ Resultados da an√°lise apareceram!")
                                        
                                        # Verificar elementos dos resultados
                                        result_elements = [
                                            "Informa√ß√µes B√°sicas",
                                            "Estat√≠sticas",
                                            "Resumo Executivo"
                                        ]
                                        
                                        for element_text in result_elements:
                                            try:
                                                element = self.driver.find_element(By.XPATH, f"//*[contains(text(), '{element_text}')]")
                                                print(f"‚úÖ Resultado encontrado: {element_text}")
                                            except NoSuchElementException:
                                                print(f"‚ö†Ô∏è Resultado n√£o encontrado: {element_text}")
                                        
                                        return True
                                        
                                    except TimeoutException:
                                        print("‚ùå Resultados n√£o apareceram ap√≥s an√°lise")
                                        return False
                                        
                                except NoSuchElementException:
                                    print("‚ùå Bot√£o 'Analisar Edital' n√£o encontrado na p√°gina de an√°lise")
                                    return False
                            else:
                                print("‚ùå Formul√°rio n√£o foi preenchido automaticamente")
                                return False
                                
                        except NoSuchElementException:
                            print("‚ùå Campo de conte√∫do do edital n√£o encontrado")
                            return False
                    else:
                        print("‚ùå N√£o chegou na p√°gina de an√°lise")
                        return False
                else:
                    print("‚ùå Nenhum bot√£o 'Analisar Edital' encontrado")
                    return False
                    
            except Exception as e:
                print(f"‚ùå Erro na an√°lise autom√°tica: {e}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro ao testar an√°lise autom√°tica: {e}")
            return False
    
    def test_navegacao_completa(self):
        """Testa navega√ß√£o completa entre p√°ginas"""
        print("\nüß™ Testando navega√ß√£o completa...")
        
        try:
            # 1. Acessar p√°gina principal
            self.driver.get(self.frontend_url)
            WebDriverWait(self.driver, self.wait_timeout).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            print("‚úÖ P√°gina principal acessada")
            
            # 2. Ir para sele√ß√£o de concursos
            self.driver.get(f"{self.frontend_url}/selecionar-concurso")
            time.sleep(3)
            print("‚úÖ P√°gina de sele√ß√£o acessada")
            
            # 3. Ir para an√°lise de editais
            self.driver.get(f"{self.frontend_url}/analise-editais")
            time.sleep(3)
            print("‚úÖ P√°gina de an√°lise acessada")
            
            # 4. Voltar para sele√ß√£o de concursos
            try:
                selecionar_btn = self.driver.find_element(By.XPATH, "//button[contains(text(), 'Selecionar Concurso')]")
                selecionar_btn.click()
                time.sleep(3)
                
                if "selecionar-concurso" in self.driver.current_url:
                    print("‚úÖ Navega√ß√£o de volta para sele√ß√£o bem-sucedida!")
                    return True
                else:
                    print("‚ùå Navega√ß√£o de volta falhou")
                    return False
                    
            except NoSuchElementException:
                print("‚ö†Ô∏è Bot√£o 'Selecionar Concurso' n√£o encontrado")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro na navega√ß√£o completa: {e}")
            return False
    
    def run_all_tests(self):
        """Executa todos os testes"""
        print("üöÄ INICIANDO TESTE COMPLETO COM SELENIUM")
        print("=" * 70)
        
        results = {}
        
        try:
            # Configurar driver
            self.setup_driver()
            
            # Executar testes
            tests = [
                ("Backend Health", self.test_backend_health),
                ("API Concursos", self.test_api_concursos),
                ("Frontend Access", self.test_frontend_access),
                ("P√°gina Sele√ß√£o", self.test_pagina_selecionar_concurso),
                ("Filtros Concursos", self.test_filtros_concursos),
                ("Sele√ß√£o Concurso", self.test_selecao_concurso),
                ("An√°lise Autom√°tica", self.test_analise_automatica),
                ("Navega√ß√£o Completa", self.test_navegacao_completa)
            ]
            
            for test_name, test_func in tests:
                print(f"\n{'='*20} {test_name} {'='*20}")
                try:
                    result = test_func()
                    results[test_name] = result
                    if result:
                        print(f"‚úÖ {test_name}: PASSOU")
                    else:
                        print(f"‚ùå {test_name}: FALHOU")
                except Exception as e:
                    print(f"üí• {test_name}: ERRO - {e}")
                    results[test_name] = False
            
        finally:
            self.teardown_driver()
        
        # Relat√≥rio final
        print("\n" + "="*70)
        print("üìä RELAT√ìRIO FINAL DOS TESTES SELENIUM")
        print("="*70)
        
        passed = sum(1 for result in results.values() if result)
        total = len(results)
        
        for test_name, result in results.items():
            status = "‚úÖ PASSOU" if result else "‚ùå FALHOU"
            print(f"{test_name}: {status}")
        
        print(f"\nüéØ RESULTADO GERAL: {passed}/{total} testes passaram")
        
        if passed == total:
            print("üéâ TODOS OS TESTES PASSARAM! Sistema funcionando perfeitamente!")
        elif passed >= total * 0.8:
            print("‚ö†Ô∏è Maioria dos testes passou. Alguns problemas menores encontrados.")
        else:
            print("‚ùå Muitos testes falharam. Sistema precisa de corre√ß√µes.")
        
        return results

def main():
    """Fun√ß√£o principal"""
    tester = TesteSistemaCompleto()
    results = tester.run_all_tests()
    
    # Salvar resultados em arquivo
    with open("test_results_selenium.json", "w") as f:
        json.dump(results, f, indent=2)
    
    print(f"\nüìÑ Resultados salvos em: test_results_selenium.json")

if __name__ == "__main__":
    main()
